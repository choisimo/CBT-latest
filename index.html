<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Diary API 명세서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa; 
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3, h4 {
            color: #212529;
            margin-bottom: 0.75em;
            scroll-margin-top: 80px; /* For scrollspy */
        }
        h1 { font-size: 2.5rem; font-weight: 700; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        h2 { font-size: 1.875rem; font-weight: 600; margin-top: 3rem; border-bottom: 1px solid #ced4da; padding-bottom: 0.5rem; }
        h3 { font-size: 1.5rem; font-weight: 600; margin-top: 2.5rem; }
        h4 { font-size: 1.25rem; font-weight: 600; margin-top: 2rem; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        th, td {
            border-bottom: 1px solid #dee2e6;
            padding: 0.875rem 1.25rem;
            text-align: left;
            vertical-align: top;
        }
        thead th {
            background-color: #f1f3f5;
            font-weight: 600;
            color: #495057;
        }
        tbody tr:last-child th,
        tbody tr:last-child td {
            border-bottom: 0;
        }
        td:first-child {
            font-weight: 500;
            width: 20%;
            color: #495057;
        }
        pre {
            background-color: #212529;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.6;
            margin-top: 0.5rem;
        }
        code {
            font-family: 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", monospace;
        }
        .toc-container {
            position: sticky;
            top: 80px;
            width: 280px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        .toc li a {
            display: block;
            padding: 0.5rem 1rem;
            text-decoration: none;
            color: #495057;
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
        }
        .toc li a:hover {
            background-color: #e9ecef;
            color: #007bff;
        }
        .toc-item.active > a {
            font-weight: 600;
            color: #0056b3;
            background-color: #e7f5ff;
            border-left-color: #007bff;
        }
        .badge {
            display: inline-block;
            padding: 0.3em 0.65em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
            font-family: sans-serif;
        }
        .badge-get { background-color: #28a745; color: white; }
        .badge-post { background-color: #007bff; color: white; }
        .badge-put { background-color: #ffc107; color: black; }
        .badge-delete { background-color: #dc3545; color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto flex gap-8">
        <aside class="toc-container flex-shrink-0">
            <div class="toc bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">API 목차</h2>
                <ul id="toc-list"></ul>
            </div>
        </aside>

        <main class="flex-grow">
            <header>
                <h1><i class="fas fa-book-open text-blue-600"></i> CBT Diary API 명세서</h1>
                <div class="text-right text-gray-500 mb-6 -mt-4" id="last-updated"></div>
            </header>

            <section id="overview">
                <h2>1. 개요</h2>
                <table>
                    <tbody>
                        <tr><td>API 버전</td><td>v2.0</td></tr>
                        <tr><td>기본 URL (개발)</td><td><code>http://localhost:8080</code></td></tr>
                        <tr><td>인증 방식</td><td>Bearer Token (JWT) - 모든 <code>/api/**</code> 경로에 필요 (public 제외)</td></tr>
                        <tr><td>응답 형식</td><td>JSON (Wrapper: <code>ApiResponse&lt;T&gt;</code>)</td></tr>
                    </tbody>
                </table>
            </section>
            
            <section id="auth-api">
                <h2>2. 인증 API (Authentication)</h2>
                <article id="login">
                    <h3>2.1. 로그인</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-post">POST</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/auth/login</code></td></tr>
                        <tr><td>설명</td><td>사용자 이메일과 비밀번호로 로그인하고 JWT 토큰을 발급받습니다.</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "email": "user@example.com",
  "password": "password123!"
}</code></pre></td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{
  "accessToken": "ey...",
  "refreshToken": "ey...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "name": "홍길동"
  }
}</code></pre></td></tr>
                        <tr><td>응답 (401 Unauthorized)</td><td>아이디 또는 비밀번호가 틀렸을 경우</td></tr>
                    </table>
                </article>
                <article id="refresh-token">
                    <h3>2.2. 토큰 재발급</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-post">POST</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/token/refresh</code></td></tr>
                        <tr><td>설명</td><td>유효한 Refresh Token을 사용하여 만료된 Access Token을 재발급받습니다.</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "refreshToken": "ey..."
}</code></pre></td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{
  "accessToken": "new_ey...",
  "refreshToken": "new_ey..." // Refresh Token Rotation 적용 시
}</code></pre></td></tr>
                        <tr><td>응답 (401 Unauthorized)</td><td>Refresh Token이 유효하지 않거나 만료되었을 경우</td></tr>
                    </table>
                </article>
            </section>

            <section id="user-api">
                <h2>3. 사용자 API (User)</h2>
                <article id="join">
                    <h3>3.1. 회원가입</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-post">POST</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/users/join</code></td></tr>
                        <tr><td>설명</td><td>새로운 사용자를 등록합니다.</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "email": "newuser@example.com",
  "password": "newPassword123!",
  "name": "김새롬"
}</code></pre></td></tr>
                        <tr><td>응답 (201 Created)</td><td>성공적으로 생성됨</td></tr>
                        <tr><td>응답 (409 Conflict)</td><td>이미 존재하는 이메일일 경우</td></tr>
                    </table>
                </article>
                 <article id="check-username">
                    <h3>3.2. 이메일 중복 확인</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-post">POST</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/users/check-username</code></td></tr>
                        <tr><td>설명</td><td>회원가입 전 이메일이 사용 가능한지 확인합니다.</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "email": "check@example.com"
}</code></pre></td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{ "isAvailable": true } // 또는 false</code></pre></td></tr>
                    </table>
                </article>
                <article id="get-profile">
                    <h3>3.3. 내 프로필 조회</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-get">GET</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/users/me</code></td></tr>
                        <tr><td>설명</td><td>현재 로그인된 사용자의 프로필 정보를 반환합니다. (인증 헤더 필요)</td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{
  "id": 1,
  "email": "user@example.com",
  "name": "홍길동",
  "provider": "LOCAL", // 또는 "GOOGLE", "NAVER", "KAKAO"
  "profileImageUrl": null
}</code></pre></td></tr>
                    </table>
                </article>
            </section>

            <section id="diary-api">
                <h2>4. 일기 API (Diary)</h2>
                <article id="create-diary">
                    <h3>4.1. 일기 작성</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-post">POST</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/diary</code></td></tr>
                        <tr><td>설명</td><td>새로운 일기를 작성합니다. 작성 성공 시, 비동기적으로 AI 분석이 시작됩니다.</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "title": "오늘 하루",
  "content": "오늘은 날씨가 좋아서 기분이 상쾌했다. 좋은 일이 생길 것 같다.",
  "weather": "맑음"
}</code></pre></td></tr>
                        <tr><td>응답 (201 Created)</td><td><pre><code>{
  "id": 101,
  "title": "오늘 하루",
  "content": "오늘은 날씨가 좋아서 기분이 상쾌했다. 좋은 일이 생길 것 같다.",
  "weather": "맑음",
  "createdAt": "2025-06-21T14:30:00"
}</code></pre></td></tr>
                    </table>
                </article>
                <article id="get-diary-by-date">
                    <h3>4.2. 특정 날짜의 일기 목록 조회</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-get">GET</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/diary/calendar?date=YYYY-MM-DD</code></td></tr>
                        <tr><td>설명</td><td>캘린더에서 특정 날짜를 선택했을 때, 해당 날짜에 작성된 일기 목록을 조회합니다.</td></tr>
                        <tr><td>쿼리 파라미터</td><td><code>date</code> (필수): "2025-06-21" 형식의 날짜</td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>[
  {
    "diaryId": 101,
    "title": "오늘 하루",
    "emotion": "행복" // AI 분석 결과 중 대표 감정
  },
  {
    "diaryId": 102,
    "title": "저녁 약속",
    "emotion": "기대"
  }
]</code></pre></td></tr>
                    </table>
                </article>
                 <article id="get-diary-detail">
                    <h3>4.3. 일기 상세 조회</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-get">GET</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/diary/{diaryId}</code></td></tr>
                        <tr><td>설명</td><td>특정 일기의 상세 내용과 AI 분석 결과를 함께 조회합니다.</td></tr>
                        <tr><td>경로 파라미터</td><td><code>diaryId</code> (Long): 조회할 일기의 ID</td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{
  "id": 101,
  "title": "오늘 하루",
  "content": "...",
  "weather": "맑음",
  "createdAt": "2025-06-21T14:30:00",
  "report": { // AI 분석이 완료된 경우
    "emotions": [{"name": "행복", "score": 0.8}],
    "solutions": ["긍정적인 감정을 친구와 나눠보세요."]
  }
}</code></pre></td></tr>
                    </table>
                </article>
                 <article id="update-diary">
                    <h3>4.4. 일기 수정</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-put">PUT</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/diary/{diaryId}</code></td></tr>
                        <tr><td>설명</td><td>기존 일기를 수정합니다. 수정 시 AI 분석이 다시 수행되지는 않습니다.</td></tr>
                        <tr><td>경로 파라미터</td><td><code>diaryId</code> (Long): 수정할 일기의 ID</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "title": "수정된 제목",
  "content": "수정된 내용입니다.",
  "weather": "흐림"
}</code></pre></td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{
  "id": 101,
  "title": "수정된 제목",
  "content": "수정된 내용입니다.",
  "weather": "흐림",
  "updatedAt": "2025-06-21T16:00:00"
}</code></pre></td></tr>
                    </table>
                </article>
                 <article id="delete-diary">
                    <h3>4.5. 일기 삭제</h3>
                    <table>
                        <tr><td>메소드</td><td><span class="badge badge-delete">DELETE</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/api/diary/{diaryId}</code></td></tr>
                        <tr><td>설명</td><td>특정 일기를 삭제합니다.</td></tr>
                        <tr><td>경로 파라미터</td><td><code>diaryId</code> (Long): 삭제할 일기의 ID</td></tr>
                        <tr><td>응답 (204 No Content)</td><td>성공적으로 삭제되었으며, 별도의 응답 본문은 없습니다.</td></tr>
                    </table>
                </article>
            </section>
            
            <section id="ai-api">
                <h2>5. AI 서버 API (내부용)</h2>
                <article id="analyze-diary">
                    <h3>5.1. 일기 분석</h3>
                     <table>
                        <tr><td>메소드</td><td><span class="badge badge-post">POST</span></td></tr>
                        <tr><td>엔드포인트</td><td><code>/analyze</code></td></tr>
                        <tr><td>설명</td><td>[내부 API] Auth-server가 일기 텍스트를 전달하여 분석을 요청하는 엔드포인트입니다.</td></tr>
                        <tr><td>요청 본문</td><td><pre><code>{
  "text": "오늘은 날씨가 좋아서 기분이 상쾌했다..."
}</code></pre></td></tr>
                        <tr><td>응답 (200 OK)</td><td><pre><code>{
  "emotions": [
    {"name": "행복", "score": 0.8},
    {"name": "평온", "score": 0.6}
  ],
  "solutions": [
    "오늘 느낀 긍정적인 감정을 친구와 나눠보세요."
  ],
  "cognitive_distortions": []
}</code></pre></td></tr>
                    </table>
                </article>
            </section>
        </main>
    </div>

    <footer class="text-center p-8 mt-12 border-t border-gray-200 text-gray-500">
        CBT Diary API Specification &copy; 2025
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Set Last Updated Date
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                lastUpdatedElement.textContent = `최종 수정: ${year}년 ${month}월 ${day}일`;
            }
            
            const tocList = document.getElementById('toc-list');
            const sections = document.querySelectorAll('main section');
            
            // Populate TOC
            sections.forEach(section => {
                const sectionTitleElement = section.querySelector('h2');
                if (!sectionTitleElement) return;

                const sectionTitle = sectionTitleElement.textContent;
                const sectionId = section.id;

                const sectionListItem = document.createElement('li');
                sectionListItem.classList.add('toc-item', 'mb-2');
                const sectionLink = document.createElement('a');
                sectionLink.href = `#${sectionId}`;
                sectionLink.textContent = sectionTitle;
                sectionLink.classList.add('font-semibold');
                sectionListItem.appendChild(sectionLink);
                
                const subList = document.createElement('ul');
                subList.classList.add('ml-4', 'mt-1', 'border-l', 'border-gray-200');

                const sectionArticles = section.querySelectorAll('article');
                sectionArticles.forEach(article => {
                    const articleTitleElement = article.querySelector('h3');
                    if (!articleTitleElement) return;

                    const articleTitle = articleTitleElement.textContent;
                    const articleId = article.id;

                    const articleListItem = document.createElement('li');
                    articleListItem.classList.add('toc-item');
                    const articleLink = document.createElement('a');
                    articleLink.href = `#${articleId}`;
                    articleLink.textContent = articleTitle;
                    articleLink.classList.add('text-sm');
                    articleListItem.appendChild(articleLink);
                    subList.appendChild(articleListItem);
                });

                if (subList.children.length > 0) {
                    sectionListItem.appendChild(subList);
                }
                tocList.appendChild(sectionListItem);
            });

            // Scrollspy
            const allTocLinks = document.querySelectorAll('.toc-item a');
            const observerCallback = (entries) => {
                let intersectingEntry = null;
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        intersectingEntry = entry;
                    }
                });
                
                allTocLinks.forEach(link => link.parentElement.classList.remove('active'));
                
                if(intersectingEntry) {
                   const id = intersectingEntry.target.getAttribute('id');
                   const activeLink = document.querySelector(`.toc-item a[href="#${id}"]`);
                   if(activeLink) {
                       activeLink.parentElement.classList.add('active');
                       // Also activate parent section if sub-item is active
                       const parentLi = activeLink.closest('ul.ml-4')?.parentElement;
                       if (parentLi) {
                           parentLi.classList.add('active');
                       }
                   }
                }
            };

            const observerOptions = {
                rootMargin: '0px 0px -80% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver(observerCallback, observerOptions);
            document.querySelectorAll('main section[id], main article[id]').forEach(el => observer.observe(el));
        });
    </script>
</body>
</html>
